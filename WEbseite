<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COFFECYCLER - Taschen aus Kaffeeverpackungen</title>
    <!-- Lade Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfiguriere Tailwind f√ºr die Verwendung der Inter-Schriftart und eines benutzerdefinierten Farbschemas --><script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'coffee-dark': '#4A2C2A', // Dunkler Kaffeebraun
                        'coffee-light': '#8B5C3D', // Heller Kaffeebraun (Hero Background)
                        'upcycle-green': '#4CAF50', // Nachhaltigkeits-Gr√ºn
                        'cream': '#F5F5F5', // Cremewei√ü
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import "tailwindcss"; /* HINWEIS: Dieses Import-Statement ist f√ºr PostCSS/Tailwind CLI vorgesehen und hat keine Funktion im CDN-Modus. Die Tailwind-Klassen funktionieren dank des Script-Tags in Zeile 9. */

        /* Grundlegende Stilkorrekturen */
        body {
            font-family: 'Inter', sans-serif;
            color: #333;
            background-color: #F5F5F5;
        }
        .section-title {
            position: relative;
            padding-bottom: 0.5rem;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background-color: #4CAF50; /* Gr√ºne Unterstreichung */
            border-radius: 9999px;
        }
        /* Eigene Klasse f√ºr Button-Effekt */
        .btn-primary {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(74, 44, 42, 0.1), 0 2px 4px -2px rgba(74, 44, 42, 0.06);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(74, 44, 42, 0.2), 0 4px 6px -4px rgba(74, 44, 42, 0.1);
        }
        /* Altes CSS-Muster entfernt, da es die Bilder verzerrt hat. */
    </style>
</head>

<body class="bg-cream">
    
    <!-- Container f√ºr Flash-Nachrichten --><div id="flash-message-container" class="fixed top-20 right-4 z-[100] max-w-xs w-full">
        <!-- Nachrichten werden hier von JS eingef√ºgt --></div>

    <!-- Header / Navigation --><header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Markenname (Text-Version) --><img src="logoneu.png" alt="Logo" class="w-20 h-20 object-contain mr-4">
            
            <!-- Desktop Navigation (ausgeblendet auf Mobile) --><nav class="hidden md:flex space-x-8">
                <a href="#produkte" class="text-lg text-coffee-dark hover:text-upcycle-green transition duration-150">Produkte</a>
                <a href="#mission" class="text-lg text-coffee-dark hover:text-upcycle-green transition duration-150">Unsere Mission</a>
                <a href="#kontakt" class="text-lg text-coffee-dark hover:text-upcycle-green transition duration-150">Kontakt</a>
            </nav>

            <!-- Warenkorb/Mobile Menu Placeholder --><div class="flex items-center space-x-4">
                <!-- Warenkorb Button mit Badge --><button id="open-cart-btn" class="relative text-coffee-dark hover:text-upcycle-green p-2 rounded-full transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-upcycle-green rounded-full hidden">0</span>
                </button>
                <button class="md:hidden text-coffee-dark hover:text-upcycle-green p-2 rounded-full transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Hero Sektion --><section class="relative bg-coffee-light text-white overflow-hidden py-24 sm:py-32">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center">
            <h1 class="text-5xl sm:text-7xl font-extrabold mb-4 leading-tight">
                <span class="block">Alte Verpackung.</span> 
                <span class="block text-upcycle-green">Neue Lieblings-Tasche.</span>
            </h1>
            <p class="text-xl sm:text-2xl mb-8 font-light max-w-3xl mx-auto">
                Handgefertigte Unikate aus upgecycelten Kaffeepackungen ‚Äì nachhaltig, robust und einzigartig.
            </p>
            <a href="#produkte" class="btn-primary inline-block bg-upcycle-green text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-green-600 transition duration-300">
                Finde hier deine neue Coffebag
            </a>
        </div>
        <!-- AKTUALISIERT: Dekoratives SVG-Muster mit vielen Bohnen -->
        <div class="absolute inset-0 opacity-30 pointer-events-none">
             <svg class="h-full w-full" viewBox="0 0 100 100" preserveAspectRatio="none" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <!-- Definition der realistischeren Bohne in coffee-dark Farbe -->
                    <g id="realistic-coffee-bean" fill="#4A2C2A"> 
                        <!-- Bohne als komplexe Form mit Kontrollpunkten (nach dem Bildstil) -->
                        <path d="M 0 50 C 0 20, 30 0, 50 0 C 70 0, 100 20, 100 50 C 100 80, 70 100, 50 100 C 30 100, 0 80, 0 50 Z"/>
                        <!-- Hellerer Schlitz in der Mitte, leicht gebogen -->
                        <path d="M 45 5 C 48 30, 48 70, 45 95" stroke="#8B5C3D" stroke-width="5" fill="none" stroke-linecap="round"/>
                    </g>
                </defs>
                
                <!-- Kaffeebohnen-Instanzen (Dichter und √ºber die gesamte Fl√§che verteilt) -->
                <!-- Reihe 1 (Oben) -->
                
                <!-- use xlink:href="#realistic-coffee-bean" x="1000" y="1000" transform="scale(0.3) rotate(-30, 85, 5)"-->
                
                <!-- Reihe 2 -->
                <!--use xlink:href="#realistic-coffee-bean" x="5000" y="0" transform="scale(0.4) rotate(0, 15, 25)"-->

                  <!-- Reihe 3 (Mitte) -->
                <!--use xlink:href="#realistic-coffee-bean" x="0" y="0" transform="scale(0.45) rotate(90, 0, 50)"/>

                <!-- Reihe 4 (Unten) -->
                <!--use xlink:href="#realistic-coffee-bean" x="0" y="0" transform="scale(0.35) rotate(-25, 10, 80)"/>
               

               
                
        

                

             </svg>
        </div>
    </section>
    
    <!-- NEUE AKTION Sektion (Promotion Banner) --><section class="bg-upcycle-green text-white py-4 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-xl font-bold tracking-wider sm:text-2xl">
                <span class="mr-2">üî• AKTION:</span> Jetzt bestellen und
                <span class="underline decoration-2 underline-offset-4">VERSANDKOSTENFREI</span> ab 35,00 ‚Ç¨ erhalten!
            </p>
        </div>
    </section>

    <!-- Produkte Sektion --><section id="produkte" class="py-16 sm:py-24 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="section-title text-4xl font-extrabold text-center text-coffee-dark mb-12">Unser Produkte</h2>

            <!-- Ge√§ndertes Layout: Nur ein Produkt, zentriert und mit maximaler Breite --><div class="max-w-sm mx-auto">
                
                <!-- Produktkarte 1: Messenger Bag (Der Kurier) --><div class="bg-cream rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-gray-100">
                    <!-- Korrigierter und robusterer Bildpfad mit Fallback --><img src="bagr.png" 
                         alt="Upcycling Messenger Bag aus Kaffeeverpackung" 
                         class="w-full h-48 object-cover"
                         onerror="this.onerror=null; this.src='https://placehold.co/600x400/4A2C2A/FFFFFF?text=Bild+wird+geladen...'">
                    <div class="p-5">
                        <h3 class="text-2xl font-semibold text-coffee-dark mb-2">Shopper-Bag</h3>
                        <p class="text-gray-600 mb-4 text-sm">Gro√üe, stabile Tasche f√ºr den Einkauf. Ein echter Hingucker!</p>
                        <div class="flex justify-between items-center">
                            <span class="text-2xl font-bold text-upcycle-green">19,99 ‚Ç¨</span>
                            <button id="add-kurier-btn" class="bg-coffee-dark text-white text-sm py-2 px-4 rounded-full btn-primary">
                                In den Warenkorb
                            </button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Ende des einzelnen Produkt-Layouts --></div>
    </section>

    <!-- Mission Sektion --><section id="mission" class="py-16 sm:py-24 bg-coffee-dark text-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="section-title text-4xl font-extrabold text-center text-white mb-12 after:bg-upcycle-green">Unsere Mission: Zero Waste</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-12 items-center">
                
                <div class="lg:col-span-2">
                    <p class="text-xl mb-6 leading-relaxed">
                        Jede Minute landen Tonnen von Verpackungsmaterial im M√ºll. Wir bei **CoffeCycler** glauben, dass diese Ressourcen einen zweiten Lebenszyklus verdienen. Statt Abfall sehen wir Kunst.
                    </p>
                    <p class="text-lg mb-6 leading-relaxed border-l-4 border-upcycle-green pl-4 italic">
                        "Jede Tasche erz√§hlt die Geschichte ihres Kaffees. Wir geben ihr ein neues, stilvolles Kapitel."
                    </p>
                    <ul class="space-y-3 text-lg">
                        <li class="flex items-start">
                            <span class="text-upcycle-green mr-3 text-2xl">‚Ä¢</span> **Handgefertigt:** Jedes St√ºck ist ein Unikat, mit Liebe in unserer kleinen Werkstatt gefertigt.
                        </li>
                        <li class="flex items-start">
                            <span class="text-upcycle-green mr-3 text-2xl">‚Ä¢</span> **Robust:** Die Innenbeschichtung der Packungen macht die Taschen langlebig und wasserabweisend.
                        </li>
                        <li class="flex items-start">
                            <span class="text-upcycle-green mr-3 text-2xl">‚Ä¢</span> **CO2-Reduzierung:** Wir reduzieren den Verpackungsm√ºll und damit Ihren √∂kologischen Fu√üabdruck.
                        </li>
                    </ul>
                </div>
                
                <div class="lg:col-span-1 flex justify-center">
                    <!-- EINGEF√úGTE DATEI: image_34cb18.jpg --><img src="uploaded:image_34cb18.jpg-9fea129a-e6a4-4cef-a0aa-c8d44c3e1d1b" 
                         alt="Klassisches 3D Recycling Logo" 
                         class="w-64 h-64 p-4 rounded-full border-4 border-white shadow-2xl bg-cream object-cover">
                </div>
            </div>
        </div>
    </section>
    
    <!-- Aufruf zum Handeln (CTA) Sektion --><section class="py-16 bg-cream">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center bg-white p-8 rounded-xl shadow-xl">
            <h3 class="text-3xl font-extrabold text-coffee-dark mb-4">M√∂chten Sie Ihren alten Kaffeebeutel spenden?</h3>
            <p class="text-lg text-gray-600 mb-6">
                Werden Sie Teil unserer Kette! Wir nehmen gerne gr√∂√üere Mengen an leeren, sauberen Kaffeeverpackungen entgegen.
            </p>
            <a href="#kontakt" class="btn-primary inline-block bg-coffee-light text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-coffee-dark transition duration-300">
                Kontaktieren Sie uns
            </a>
        </div>
    </section>

    <!-- Footer / Kontakt --><footer id="kontakt" class="bg-gray-800 text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-4 gap-8">
            
            <!-- Spalte 1: Markenname --><div>
                <h3 class="text-2xl font-bold mb-4 text-upcycle-green">CoffeCycler</h3>
                <p class="text-sm text-gray-400">
                    Upcycling-Handwerk mit Leidenschaft f√ºr Nachhaltigkeit. Jede Tasche ein Beitrag zum Umweltschutz.
                </p>
            </div>

            <!-- Spalte 2: Navigation --><div>
                <h4 class="text-xl font-semibold mb-4 border-b border-upcycle-green pb-1">Navigation</h4>
                <ul class="space-y-2 text-gray-400">
                    <li><a href="#produkte" class="hover:text-white transition duration-150">Shop</a></li>
                    <li><a href="#mission" class="hover:text-white transition duration-150">Unsere Geschichte</a></li>
                    <li><a href="#kontakt" class="hover:text-white transition duration-150">FAQ & Hilfe</a></li>
                </ul>
            </div>

            <!-- Spalte 3: Kontaktinformationen --><div>
                <h4 class="text-xl font-semibold mb-4 border-b border-upcycle-green pb-1">Kontakt</h4>
                <address class="space-y-2 text-gray-400 not-italic">
                    <p>CoffeCycler Manufaktur</p>
                    <p>Musterstra√üe 42, 12345 Berlin</p>
                    <p>E-Mail: <a href="mailto:hallo@coffecycler.de" class="hover:text-white">hallo@coffecycler.de</a></p>
                    <p>Telefon: +49 (0) 30 123 456</p>
                </address>
            </div>

            <!-- Spalte 4: Social Media --><div>
                <h4 class="text-xl font-semibold mb-4 border-b border-upcycle-green pb-1">Folge uns</h4>
                <div class="flex space-x-4">
                    <!-- Platzhalter Icons --><a href="#" class="text-gray-400 hover:text-upcycle-green transition duration-150 p-2 rounded-full border border-gray-700 hover:border-upcycle-green">
                        <!-- Instagram Icon (Mundgerechte SVG) --><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.5 14h-7a.5.5 0 01-.5-.5v-7a.5.5 0 01.5-.5h7a.5.5 0 01.5.5v7a.5.5 0 01-.5.5zm-5.5-7.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm6 0h-1c-.55 0-1 .45-1 1s.45 1 1 1h1c.55 0 1-.45 1-1s-.45-1-1-1zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm4 4c0 2.21-1.79 4-4 4s-4-1.79-4-4 1.79-4 4-4 4 1.79 4 4z"/>
                        </svg>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-upcycle-green transition duration-150 p-2 rounded-full border border-gray-700 hover:border-upcycle-green">
                        <!-- Facebook Icon (Mundgerechte SVG) --><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.97 3.63 9.17 8.41 9.85V14.65h-2.54v-2.73h2.54V9.92c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.06.08 2.33.12v2.7h-1.39c-1.22 0-1.45.58-1.45 1.43v1.8h2.95l-.48 2.73h-2.47V21.85C18.37 21.17 22 16.97 22 12z"/>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Urheberrecht --><div class="mt-8 pt-6 border-t border-gray-700 text-center text-sm text-gray-500">
            &copy; 2025 CoffeCycler. Alle Rechte vorbehalten. | <a href="#" class="hover:text-white">Impressum</a> | <a href="#" class="hover:text-white">Datenschutz</a>
        </div>
    </footer>

    <!-- Warenkorb Sidebar (Modal) --><!-- Overlay --><div id="cart-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300"></div>

    <!-- Sidebar --><div id="cart-sidebar" class="fixed top-0 right-0 w-full md:w-96 h-full bg-white z-50 shadow-2xl transform translate-x-full transition-transform duration-300 overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 class="text-3xl font-bold text-coffee-dark">Warenkorb</h3>
                <button id="close-cart-btn" class="text-gray-500 hover:text-coffee-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- NEUER FORTSCHRITTSBALKEN HIER EINGEF√úGT --><div id="shipping-progress" class="mb-6 hidden">
                <p id="progress-text" class="text-sm font-semibold mb-2 text-center text-gray-700"></p>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="bg-upcycle-green h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <!-- Ende des Fortschrittsbalkens --><!-- Promotion Message --><div id="promo-message" class="bg-upcycle-green/10 text-upcycle-green p-3 rounded-lg mb-6 text-sm font-semibold hidden">
                <p id="promo-message-text" class="text-center"></p>
            </div>
            
            <!-- Warenkorb Artikel --><div id="cart-items" class="min-h-[100px]">
                <!-- Artikel werden hier von JS eingef√ºgt --></div>

            <!-- Warenkorb Summen --><div id="cart-totals" class="mt-6 pt-4 border-t border-gray-200 hidden">
                <div class="flex justify-between text-lg mb-2">
                    <span>Zwischensumme:</span>
                    <span id="subtotal-value" class="font-semibold">0,00 ‚Ç¨</span>
                </div>
                <div class="flex justify-between text-lg mb-2">
                    <span>Versandkosten:</span>
                    <span id="shipping-value" class="font-semibold text-red-500">4,99 ‚Ç¨</span>
                </div>
                <div class="flex justify-between text-2xl font-bold mt-4 pt-4 border-t border-coffee-dark">
                    <span>Gesamt:</span>
                    <span id="total-value" class="text-coffee-dark">0,00 ‚Ç¨</span>
                </div>
            </div>

            <!-- Checkout Button --><button class="w-full bg-upcycle-green text-white font-bold py-3 mt-8 rounded-lg text-xl btn-primary hover:bg-green-600">
                Zur Kasse
            </button>
        </div>
        
    </div>
    
    <!-- JavaScript Logik (Firebase & Warenkorb) -->
    <script type="module">
        // **HINWEIS ZUM SYNTAXFEHLER: Imports M√úSSEN au√üerhalb von Bl√∂cken stehen.**
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Lese die globalen Variablen einmalig und stelle sicher, dass sie einen Wert haben (Fallback).
        const rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const isCanvasEnv = rawFirebaseConfig && Object.keys(rawFirebaseConfig).length > 0 && rawFirebaseConfig.projectId;

        const firebaseConfig = isCanvasEnv
            ? rawFirebaseConfig 
            : { apiKey: "dummy-key", authDomain: "dummy.firebaseapp.com", projectId: "dummy" }; 
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        

        let db;
        let auth;
        let userId = null;
        let cartCollectionRef;
        const shippingCost = 4.99;
        const freeShippingThreshold = 35.00; 

        // Initialer lokaler Zustand des Warenkorbs (wird von Firestore √ºberschrieben)
        const cartState = {
            'product_id_kurier': {
                name: 'Der Kurier',
                price: 19.99,
                quantity: 0,
                id: 'product_id_kurier'
            }
        };
        
        // ===================================
        // HILFSFUNKTIONEN (Sichtbarkeit/Feedback)
        // ===================================

        /**
         * Zeigt eine tempor√§re Benachrichtigung an
         */
        function showFlashMessage(message, type = 'success') {
            const flashContainer = document.getElementById('flash-message-container');
            if (!flashContainer) return;

            const div = document.createElement('div');
            let bgColor = 'bg-gray-500';
            if (type === 'success') bgColor = 'bg-upcycle-green';
            else if (type === 'error') bgColor = 'bg-red-500';
            
            div.className = `${bgColor} p-3 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300 mb-2`;
            div.textContent = message;
            
            flashContainer.prepend(div);

            setTimeout(() => {
                div.style.opacity = '0';
                setTimeout(() => div.remove(), 300);
            }, 2000);
        }

        // ===================================
        // WARENKORB LOGIK (mit Firebase-Anbindung)
        // ===================================

        /**
         * √Ñndert die Menge eines Produkts im Warenkorb.
         */
        window.updateCartQuantity = (productId, change) => {
             // Wenn userId noch nicht gesetzt ist (w√§hrend der Firebase Init), benutze nur die lokale Logik
             if (!userId) {
                const item = cartState[productId];
                if (item) {
                    item.quantity = Math.max(0, item.quantity + change);
                    renderCart();
                }
                return;
             }
            
            // Echte Firebase Logik
            const item = cartState[productId];
            if (!item) return;

            const currentQuantity = item.quantity;
            const newQuantity = Math.max(0, currentQuantity + change);
            
            if (newQuantity !== currentQuantity) {
                item.quantity = newQuantity;
                updateFirestoreCart();
            }
        };
        
        /**
         * F√ºgt ein Produkt zum Warenkorb hinzu (Menge +1).
         */
        window.addToCart = (productId) => {
            if (!userId) {
                showFlashMessage("Wird geladen. Bitte warten Sie kurz.", 'info');
                // F√ºhrt die lokale Logik aus, auch wenn userId fehlt
                window.updateCartQuantity(productId, 1);
            } else {
                 window.updateCartQuantity(productId, 1);
            }
            
            document.getElementById('cart-sidebar').classList.remove('translate-x-full');
            document.getElementById('cart-overlay').classList.remove('hidden');
            
            showFlashMessage('Produkt zum Warenkorb hinzugef√ºgt!', 'success');
        };


        // ===================================
        // FIREBASE / FIRESTORE LOGIK
        // ===================================

        async function initializeFirebase() {
            try {
                const isLocalMode = firebaseConfig.projectId === 'dummy';

                if (isLocalMode) {
                     // Lokaler Modus: UI-Events sind bereits im DOMContentLoaded-Handler gesetzt.
                     console.warn("Warenkorb: L√§uft im reinen UI-Modus (keine Datenbank-Persistenz).");
                     userId = 'local_user_' + Math.random().toString(36).substring(2, 9);
                     showFlashMessage("Hinweis: Lokaler Modus aktiv. Der Warenkorb wird nicht gespeichert.", 'info');
                     renderCart();
                     return; 
                }

                // Echte Firebase-Initialisierung nur, wenn die Konfiguration g√ºltig ist
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    } else {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                    
                    cartCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/carts`);
                    setupCartListener();
                });

            } catch (error) {
                console.error("Error initializing Firebase or Auth:", error);
                showFlashMessage("Kritischer Fehler bei der Initialisierung.", 'error');
                // Wenn die Initialisierung fehlschl√§gt, schalte auf lokalen Modus um.
                userId = 'error_user_' + Math.random().toString(36).substring(2, 9);
                renderCart();
            }
        }

        function setupCartListener() {
            if (!cartCollectionRef || !userId || firebaseConfig.projectId === 'dummy') return;

            const cartDocRef = doc(db, `artifacts/${appId}/users/${userId}/carts/current_cart`);
            
            onSnapshot(cartDocRef, (docSnapshot) => {
                if (docSnapshot.exists() && docSnapshot.data().items) {
                    Object.keys(cartState).forEach(key => {
                        const savedItem = docSnapshot.data().items[key];
                        cartState[key].quantity = savedItem ? savedItem.quantity : 0;
                    });
                } else {
                    Object.keys(cartState).forEach(key => {
                        cartState[key].quantity = 0;
                    });
                }
                renderCart();
            }, (error) => {
                console.error("Firestore snapshot listener failed:", error);
                if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                    showFlashMessage("Fehler: Fehlende Firestore-Berechtigungen. Speicherung deaktiviert.", 'error');
                }
            });
        }

        async function updateFirestoreCart() {
            if (!userId || firebaseConfig.projectId === 'dummy') {
                renderCart();
                return;
            }
            
            const cartDocRef = doc(db, `artifacts/${appId}/users/${userId}/carts/current_cart`);
            
            try {
                const itemsToSave = {};
                for (const key in cartState) {
                    if (cartState[key].quantity > 0) {
                        itemsToSave[key] = {
                            name: cartState[key].name,
                            price: cartState[key].price,
                            quantity: cartState[key].quantity,
                            id: key
                        };
                    }
                }

                await setDoc(cartDocRef, { items: itemsToSave });
            } catch (error) {
                console.error("Error updating cart in Firestore:", error);
            }
        }
        
        // ===================================
        // RENDERING & BERECHNUNGEN
        // ===================================

        function calculateCart() {
            let subtotal = 0;
            let totalItems = 0;
            
            for (const key in cartState) {
                if (cartState[key].quantity > 0) {
                    subtotal += cartState[key].price * cartState[key].quantity;
                    totalItems += cartState[key].quantity;
                }
            }

            let shipping = shippingCost;
            let promotionMessage = '';

            if (subtotal >= freeShippingThreshold) {
                shipping = 0;
                promotionMessage = 'Kostenloser Versand! Ihr Warenkorb ist versandkostenfrei!';
            } else {
                const remainingAmount = freeShippingThreshold - subtotal;
                promotionMessage = `Sie sparen 4,99 ‚Ç¨ Versandkosten, wenn Sie noch ${remainingAmount.toFixed(2).replace('.', ',')} ‚Ç¨ erreichen!`;
            }

            const total = subtotal + shipping;
            
            // Berechnung des Fortschritts f√ºr den Balken (0 bis 100)
            const progress = Math.min(100, (subtotal / freeShippingThreshold) * 100);


            return { subtotal, totalItems, shipping, total, promotionMessage, progress };
        }

        function renderCart() {
            const { subtotal, totalItems, shipping, total, promotionMessage, progress } = calculateCart();
            const cartItemsContainer = document.getElementById('cart-items');
            const cartBadge = document.getElementById('cart-badge');
            const cartTotals = document.getElementById('cart-totals');
            const promoMessageElement = document.getElementById('promo-message');
            const shippingProgressContainer = document.getElementById('shipping-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            
            if (!cartItemsContainer || !cartBadge) return;

            // 1. Update Badge
            cartBadge.textContent = totalItems;
            cartBadge.classList.toggle('hidden', totalItems === 0);
            
            // 2. Render Cart Items
            cartItemsContainer.innerHTML = '';
            let hasItems = false;

            for (const key in cartState) {
                const item = cartState[key];
                if (item.quantity > 0) {
                    hasItems = true;
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center border-b border-gray-200 py-3';
                    // replace('.', ',') f√ºr deutsches Format
                    itemElement.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-coffee-dark">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.quantity} x ${item.price.toFixed(2).replace('.', ',')} ‚Ç¨</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateCartQuantity('${key}', -1)" class="text-gray-500 hover:text-red-500 px-2 rounded-full border border-gray-300 hover:border-red-500 transition duration-150">-</button>
                            <span class="font-bold">${item.quantity}</span>
                            <button onclick="updateCartQuantity('${key}', 1)" class="text-gray-500 hover:text-upcycle-green px-2 rounded-full border border-gray-300 hover:border-upcycle-green transition duration-150">+</button>
                        </div>
                        <span class="ml-4 font-bold text-coffee-light">${(item.price * item.quantity).toFixed(2).replace('.', ',')} ‚Ç¨</span>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                }
            }
            
            // 3. Handle Empty Cart
            if (!hasItems) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500 py-8">Ihr Warenkorb ist leer.</p>';
                cartTotals.classList.add('hidden');
                promoMessageElement.classList.add('hidden');
                shippingProgressContainer.classList.add('hidden');
                return;
            }

            // 4. Render Totals
            cartTotals.classList.remove('hidden');
            document.getElementById('subtotal-value').textContent = subtotal.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            
            // Versandkostenanzeige hervorheben
            const shippingValueElement = document.getElementById('shipping-value');
            shippingValueElement.textContent = shipping === 0 ? 'Kostenlos' : shipping.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            shippingValueElement.classList.toggle('text-upcycle-green', shipping === 0);
            shippingValueElement.classList.toggle('text-red-500', shipping > 0);
            
            document.getElementById('total-value').textContent = total.toFixed(2).replace('.', ',') + ' ‚Ç¨';

            // 5. Render Promotion Message
            document.getElementById('promo-message-text').textContent = promotionMessage;
            promoMessageElement.classList.remove('hidden');
            
            // 6. Render Progress Bar
            shippingProgressContainer.classList.remove('hidden');
            progressBar.style.width = `${progress}%`;
            progressText.textContent = promotionMessage;
            
            // Text im Progress Bar Container nur anzeigen, wenn Versand noch nicht frei ist
            const progressTextColor = (subtotal >= freeShippingThreshold) ? 'text-upcycle-green' : 'text-gray-700';
            progressText.className = `text-sm font-semibold mb-2 text-center ${progressTextColor}`;
        }

        // ===================================
        // EVENT LISTENER SETUP
        // ===================================

        function setupEventListeners() {
            // 1. Warenkorb-Toggle
            const cartButton = document.getElementById('open-cart-btn');
            const closeButton = document.getElementById('close-cart-btn');
            const overlay = document.getElementById('cart-overlay');
            const sidebar = document.getElementById('cart-sidebar');

            cartButton.addEventListener('click', () => {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            });

            closeButton.addEventListener('click', () => {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            });

            // 2. Add-to-Cart Button
            const addKurierBtn = document.getElementById('add-kurier-btn');
            if (addKurierBtn) {
                // Wir verwenden die globale Funktion addToCart()
                addKurierBtn.addEventListener('click', () => window.addToCart('product_id_kurier'));
            }
        }

        // Initialisierung bei DOM-Load
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initializeFirebase();
        });
    </script>
</body>
</html>
